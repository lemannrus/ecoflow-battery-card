<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eco Battery Card Test - v0.2.0 (Outage Management)</title>
  <style>
    :root {
      --primary-text-color: #e1e1e1;
      --secondary-text-color: #9b9b9b;
      --error-color: #e53935;
      --warning-color: #fbc02d;
      --success-color: #43a047;
      --card-background-color: #1c1c1c;
      --divider-color: #383838;
      --ha-card-border-radius: 12px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #111111;
      color: var(--primary-text-color);
      padding: 20px;
      margin: 0;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #43a047;
    }

    .subtitle {
      text-align: center;
      color: var(--secondary-text-color);
      margin-bottom: 40px;
      font-size: 14px;
    }

    .section-title {
      text-align: center;
      color: var(--primary-text-color);
      margin: 40px 0 20px;
      font-size: 20px;
      font-weight: 600;
    }

    .test-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .test-card-wrapper {
      background: var(--card-background-color);
      border-radius: var(--ha-card-border-radius);
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .test-label {
      font-size: 12px;
      color: var(--secondary-text-color);
      margin-bottom: 12px;
      text-align: center;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    ha-card {
      display: block;
      background: var(--card-background-color);
      border-radius: var(--ha-card-border-radius);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <h1>üîã Eco Battery Card Test Page</h1>
  <div class="subtitle">Version 0.2.0 - Testing outage management, battery analysis, and smart recommendations</div>

  <div class="section-title">üîå Outage Scenarios & Discharge Mode</div>
  <div id="discharge-container" class="test-container"></div>

  <div class="section-title">‚ö° Charge Mode & Next Outage Analysis</div>
  <div id="charge-container" class="test-container"></div>

  <div class="section-title">üîã Connected Mode (Idle - Not Charging/Discharging)</div>
  <div id="connected-container" class="test-container"></div>

  <div class="section-title">üé® Various Configurations</div>
  <div id="misc-container" class="test-container"></div>

  <!-- Load Lit from CDN first -->
  <script type="module">
    import { LitElement, html, css, svg } from 'https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js';

    // The card extracts the parent class with Object.getPrototypeOf()
    // Then accesses html/css/svg from that parent's prototype
    // So we need to attach html/css/svg to LitElement's prototype
    LitElement.prototype.html = html;
    LitElement.prototype.css = css;
    LitElement.prototype.svg = svg;

    // Create a proper mock Home Assistant base element
    class MockHABase extends LitElement { }

    // Define the mock HA panel element before the card loads
    if (!customElements.get('ha-panel-lovelace')) {
      customElements.define('ha-panel-lovelace', MockHABase);
    }

    // Create mock HASS object factory
    window.createMockHass = (batteryLevel, dischargeTime = null, chargeTime = null, acOutPower = null, outageActive = false, outageEndMinutes = 120, nextOutageMinutes = 240) => ({
      states: {
        'sensor.ecoflow_battery': {
          state: String(batteryLevel),
          attributes: {
            friendly_name: 'EcoFlow Battery',
            unit_of_measurement: '%'
          }
        },
        'sensor.delta_2_discharge_remaining_time': dischargeTime !== null ? {
          state: String(dischargeTime),
          attributes: {
            friendly_name: 'Discharge Remaining Time'
          }
        } : {
          state: 'unavailable',
          attributes: {}
        },
        'sensor.delta_2_charge_remaining_time': chargeTime !== null ? {
          state: String(chargeTime),
          attributes: {
            friendly_name: 'Charge Remaining Time'
          }
        } : {
          state: 'unavailable',
          attributes: {}
        },
        'sensor.delta_2_ac_out_power': acOutPower !== null ? {
          state: String(acOutPower),
          attributes: {
            friendly_name: 'AC Output Power',
            unit_of_measurement: 'W'
          }
        } : {
          state: 'unavailable',
          attributes: {}
        },
        'sensor.outage_status': {
          state: outageActive ? 'on' : 'off',
          attributes: {
            friendly_name: 'Outage Status'
          }
        },
        'sensor.outage_end': outageActive ? {
          state: new Date(Date.now() + outageEndMinutes * 60000).toISOString(),
          attributes: {
            friendly_name: 'Outage End Time'
          }
        } : {
          state: 'unavailable',
          attributes: {}
        },
        'sensor.next_outage': !outageActive ? {
          state: new Date(Date.now() + nextOutageMinutes * 60000).toISOString(),
          attributes: {
            friendly_name: 'Next Outage Time'
          }
        } : {
          state: 'unavailable',
          attributes: {}
        }
      }
    });

    // Wait a moment for the custom element to be fully registered
    await customElements.whenDefined('ha-panel-lovelace');

    console.log('‚úì Mock HA environment ready');

    // Now load the card script
    const loadCardScript = () => {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = './eco-battery-card.js';
        script.onload = () => {
          console.log('‚úì Card script loaded');
          resolve();
        };
        script.onerror = (error) => {
          console.error('‚úó Failed to load card script');
          reject(error);
        };
        document.head.appendChild(script);
      });
    };

    try {
      await loadCardScript();

      // Wait for the custom element to be defined
      await customElements.whenDefined('eco-battery-card');

      console.log('‚úì eco-battery-card registered');

      // Discharge Mode Tests
      const dischargeConfigs = [
        {
          label: 'OUTAGE: Sufficient - 150min battery vs 120min outage ‚úÖ',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(65, 150, 0, 450, true, 120) // OUTAGE: 150min battery, 120min outage
        },
        {
          label: 'OUTAGE: CRITICAL - 90min battery vs 150min outage ‚ö†Ô∏è',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(35, 90, 0, 650, true, 150) // CRITICAL: 90min battery, 150min outage!
        },
        {
          label: 'Normal Operation - 5h 33min - 350W output',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(85, 333, 0, 350, false, 120, 240) // No outage, next in 4h
        },
        {
          label: 'Low Battery (20%) - 45min - Next outage in 2h',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(20, 45, 0, 750, false, 120, 120) // Next outage in 2h
        }
      ];

      // Charge Mode Tests
      const chargeConfigs = [
        {
          label: 'Charging (45%) - Tight! Next outage in 90min ‚è∞',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(45, 0, 35, 0, false, 120, 90) // Need 35min to charge, outage in 90min
        },
        {
          label: 'Charging (50%) - 2h to full, outage in 4h ‚úÖ',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(50, 0, 120, 0, false, 120, 240) // Plenty of time
        },
        {
          label: 'Charging (75%) - 1h 15min to full',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            outage_status_entity: 'sensor.outage_status',
            outage_end_time_entity: 'sensor.outage_end',
            next_outage_time_entity: 'sensor.next_outage',
            charge_rate_watts: 1200,
            battery_capacity_wh: 1024,
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(75, 0, 75, 0, false, 120, 240)
        },
        {
          label: 'Almost Full (95%) - 30min to full',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(95, 0, 30)
        }
      ];

      // Connected Mode Tests (idle - neither charging nor discharging)
      const connectedConfigs = [
        {
          label: 'Connected - Full Battery (100%)',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(100, 0, 0, 0) // Both time sensors at 0, no power
        },
        {
          label: 'Connected - High Battery (85%)',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(85, 0, 0) // Both sensors at 0
        },
        {
          label: 'Connected - Medium Battery (60%)',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(60, 0, 0)
        },
        {
          label: 'Connected - Low Battery (30%)',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(30, 0, 0)
        }
      ];

      // Misc Tests
      const miscConfigs = [
        {
          label: 'Gradient Mode - Discharging 900W',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            palette: 'gradient',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(72, 180, 0, 900)
        },
        {
          label: 'Gradient Mode - Charging (no power)',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            palette: 'gradient',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(42, 0, 150, 0)
        },
        {
          label: 'No Sensors - Just Battery %',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            palette: 'threshold',
            segments: 5,
            gap: 3
          },
          hass: createMockHass(67)
        },
        {
          label: '10 Segments - 2.5kW Output',
          config: {
            entity: 'sensor.ecoflow_battery',
            name: 'EcoFlow Delta 2',
            remaining_time_entity: 'sensor.delta_2_discharge_remaining_time',
            charge_remaining_time_entity: 'sensor.delta_2_charge_remaining_time',
            ac_out_power_entity: 'sensor.delta_2_ac_out_power',
            palette: 'threshold',
            segments: 10,
            gap: 2
          },
          hass: createMockHass(63, 90, 0, 2500)
        }
      ];

      // Helper function to render cards
      const renderCards = (configs, containerId) => {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        configs.forEach(({ label, config, hass }) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'test-card-wrapper';

          const labelDiv = document.createElement('div');
          labelDiv.className = 'test-label';
          labelDiv.textContent = label;

          const card = document.createElement('eco-battery-card');
          card.setConfig(config);
          card.hass = hass;

          wrapper.appendChild(labelDiv);
          wrapper.appendChild(card);
          container.appendChild(wrapper);
        });
      };

      // Render all test sections
      renderCards(dischargeConfigs, 'discharge-container');
      renderCards(chargeConfigs, 'charge-container');
      renderCards(connectedConfigs, 'connected-container');
      renderCards(miscConfigs, 'misc-container');

      console.log('‚úì Test cards rendered successfully');
      console.log('üìä Total cards:', dischargeConfigs.length + chargeConfigs.length + connectedConfigs.length + miscConfigs.length);

    } catch (error) {
      console.error('‚úó Error initializing test page:', error);
      document.body.innerHTML =
        `<div style="text-align:center;color:var(--error-color);padding:40px;max-width:800px;margin:0 auto;">
          <h2>‚ùå Error Loading Card</h2>
          <p>Make sure <code>eco-battery-card.js</code> is in the same directory as this HTML file.</p>
          <p style="font-family:monospace;font-size:12px;margin-top:20px;background:#222;padding:20px;border-radius:8px;">${error.message || error}</p>
        </div>`;
    }
  </script>
</body>

</html>